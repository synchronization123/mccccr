import requests
import pandas as pd
import os

# API details
API_URL = "https://dependencytrackapi.crm.com/api/v1/project"
FINDINGS_API_URL = "https://dependencytrackapi.crm.com/api/v1/finding/project"
API_TOKEN = "bzbdbdhdhd"
HEADERS = {
    "X-Api-Key": API_TOKEN,
    "Content-Type": "application/json",
    "Accept": "application/json"
}

def fetch_all_dependency_data():
    """Fetch all pages of Dependency Track API data."""
    all_data = []
    page = 1
    limit = 100  # Number of records per request

    while True:
        params = {"page": page, "limit": limit}  # Pagination parameters
        try:
            response = requests.get(API_URL, headers=HEADERS, params=params)
            response.raise_for_status()
            data = response.json()

            if not data:
                break  # Stop if no more records
            
            all_data.extend(data)  # Append current batch to full list

            print(f"Fetched {len(data)} records from page {page}")

            # Stop if fewer than 'limit' records are returned (last page)
            if len(data) < limit:
                break

            page += 1  # Move to next page
        except requests.exceptions.RequestException as e:
            print(f"Error fetching data: {e}")
            break

    return all_data

def fetch_findings_for_uuid(uuid):
    """Fetch findings for a specific UUID."""
    url = f"{FINDINGS_API_URL}/{uuid}"
    try:
        response = requests.get(url, headers=HEADERS)
        response.raise_for_status()
        data = response.json()

        if not data:
            print(f"No findings for UUID: {uuid}. Saving blank Excel.")
            # Create blank Excel file with headers if no data
            df = pd.DataFrame(columns=["Finding", "Severity", "Description"])  # Example headers
            df.to_excel(f"DTResult_{uuid}.xlsx", index=False)
            print(f"Blank Excel file created for UUID: {uuid}")
        else:
            # Convert findings data to a DataFrame and save to Excel
            df = pd.json_normalize(data)
            df.to_excel(f"DTResult_{uuid}.xlsx", index=False)
            print(f"Data successfully saved for UUID: {uuid}")

    except requests.exceptions.RequestException as e:
        print(f"Error fetching findings for UUID {uuid}: {e}")

def main():
    # Fetch all projects to get UUIDs
    all_projects = fetch_all_dependency_data()

    for project in all_projects:
        uuid = project.get('uuid')
        if uuid:
            fetch_findings_for_uuid(uuid)
        else:
            print("UUID not found in project data.")

if __name__ == "__main__":
    main()