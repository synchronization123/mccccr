import os
import pandas as aD2
from openpyxl import load_workbook as Lw8
from tkinter import filedialog as Fd9, messagebox as Mb7, ttk as Tk3, Tk as Tk1, Label as Lb3, Entry as Et5, Button as Bt6
from tkcalendar import DateEntry as Dt1

def pr0c355():
    x1 = n2.get().strip()
    x2 = n3.get().strip()
    x3 = n4.get().strip()
    x4 = d1.get_date().strftime("%Y-%m-%d")
    x5 = n5.get().strip()
    x6 = "C://user//template//report.xlsx"

    if not x1 or not x2 or not x3 or not x5:
        Mb7.showerror("Err0r", "F1ll 4ll f13ld5!")
        return

    try:
        s1.config(text="Pr0c3551ng...", foreground="blue")
        rt.update_idletasks()

        if not os.path.exists(x6):
            Mb7.showerror("Err0r", f"F1l3 n0t f0und: {x6}")
            return

        x7 = f"{x2}.xlsx"
        wb = Lw8(x6)
        d0 = aD2.read_csv(x5)
        d1 = d0.set_index('Issue key').to_dict('index')
        l1 = list(d1.keys())

        s_c, m_t, j_t = [], [], []
        w_m_t = []
        f_t, s_t = 0, 0

        f_l = ['security', 'appsecurity', 'ram', 'dan', 'kan', 'van']

        for k in d1:
            f1, f2, f3 = False, False, False
            for k1 in d1[k]:
                c = str(d1[k][k1]).lower()

                if not f2 and x1 in c and 'security validation' in c:
                    s_c.append(c.split('comments:')[1][:-3])
                    f2 = True
                    if 'manual testing:' in c:
                        mt = c.split('manual testing:')[1][:6]
                        if not f3 and 'done' in mt:
                            m_t.append('D0n3')
                            f3 = True

                if not f1 and ('Component' in str(k1) or 'QA-TeamLead' in str(k1)):
                    if c.lower() in f_l:
                        f1 = True
                        j_t.append('S3c_J1r4')

            if not f1:
                j_t.append('Fnc_J1r4')
            if not f2:
                s_c.append('N/A')
            if not f3:
                m_t.append('N/A')

            w_m_t.append(' ' if m_t[-1] == 'D0n3' else 'Functional' if j_t[-1] == 'Fnc_J1r4' else 'Security')

        df = aD2.DataFrame({'J1R4': l1, 'S3c': s_c, 'J_Typ3': j_t, 'M_T': m_t, 'W_M_T': w_m_t})

        f_p = os.path.join(os.getcwd(), "0utput.csv")

        if os.path.exists(f_p):
            os.remove(f_p)

        with open(f_p, "w+", newline='', encoding="utf-8") as f:
            df.to_csv(f, index=False)

        os.chmod(f_p, 0o777)

        sh = wb["Build Analysis"]
        sm_sh = wb["Summary"]

        sh["A3"] = x2
        sh["B3"] = x4
        sh["E3"] = x3

        u_n = os.getlogin().replace('.', ' ')
        sh["D3"] = u_n.title()
        sm_sh["B1"] = x2

        sr = 3
        while sh[f"F{sr}"].value:
            sr += 1

        for i, (a, b, c, d, e) in enumerate(zip(df["J1R4"], df["J_Typ3"], df["M_T"], df["S3c"], df["W_M_T"]), start=sr):
            sh[f"F{i}"] = a
            sh[f"G{i}"] = b
            sh[f"I{i}"] = c
            sh[f"J{i}"] = d
            sh[f"K{i}"] = e
            if b == "Fnc_J1r4":
                f_t += 1
            elif b == "S3c_J1r4":
                s_t += 1

        t_f = sum(1 for row in range(3, sh.max_row + 1) if sh[f"F{row}"].value)
        sh["C3"] = t_f

        sm_sh["C3"] = f_t
        sm_sh["C4"] = s_t

        wb.save(x7)
        s1.config(text="C0mpl3t3d!", foreground="green")
        Mb7.showinfo("Succ3ss", f"S4v3d 45: {x7}")

    except Exception as e:
        s1.config(text="Err0r!", foreground="red")
        Mb7.showerror("Err0r", str(e))

def br0ws3():
    f = Fd9.askopenfilename(filetypes=[("CSV", "*.csv")])
    if f:
        n5.delete(0, "end")
        n5.insert(0, f)

rt = Tk1()
rt.title("D4T4 Pr0C355")
rt.geometry("550x320")
rt.resizable(False, False)

Lb3(rt, text="P-ID:").grid(row=0, column=0, padx=10, pady=5, sticky="w")
n2 = Et5(rt, width=40)
n2.grid(row=0, column=1, padx=10, pady=5)

Lb3(rt, text="B_N4M3:").grid(row=1, column=0, padx=10, pady=5, sticky="w")
n3 = Et5(rt, width=40)
n3.grid(row=1, column=1, padx=10, pady=5)

Lb3(rt, text="D4T3:").grid(row=2, column=0, padx=10, pady=5, sticky="w")
d1 = Dt1(rt, width=12, background="darkblue", foreground="white", date_pattern="yyyy-mm-dd")
d1.grid(row=2, column=1, padx=10, pady=5)

Lb3(rt, text="T_T4K3N:").grid(row=3, column=0, padx=10, pady=5, sticky="w")
n4 = Et5(rt, width=40)
n4.grid(row=3, column=1, padx=10, pady=5)

Lb3(rt, text="CSV:").grid(row=4, column=0, padx=10, pady=5, sticky="w")
n5 = Et5(rt, width=30)
n5.grid(row=4, column=1, padx=10, pady=5)
Bt6(rt, text="Br0w53", command=br0ws3).grid(row=4, column=2)

Bt6(rt, text="Pr0c355", command=pr0c355).grid(row=5, column=1, pady=20)
s1 = Lb3(rt, text="", font=("Arial", 10, "bold"))
s1.grid(row=6, column=1, pady=5)

rt.mainloop()